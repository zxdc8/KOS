//setup ship
set RAP1 to SHIP:PARTSDUBBED("RAP1")[0].
set RAP2 to SHIP:PARTSDUBBED("RAP2")[0].
set RAP3 to SHIP:PARTSDUBBED("RAP3")[0].
set RAPV1 to SHIP:PARTSDUBBED("RAPV1")[0].
set RAPV2 to SHIP:PARTSDUBBED("RAPV2")[0].
set RAPV3 to SHIP:PARTSDUBBED("RAPV3")[0].

set FINLF to SHIP:PARTSDUBBED("FINLF")[0].
set FINRF to SHIP:PARTSDUBBED("FINRF")[0].
set FINLR to SHIP:PARTSDUBBED("FINLR")[0].
set FINRR to SHIP:PARTSDUBBED("FINRR")[0].

//Coast to apogee
LOCK THROTTLE TO 0.0.
RCS ON.

UNTIL VERTICALSPEED < 50{
	PRINT "WAITING FOR APOGEE...".
	WAIT 5.
}

//Flip Horizontal
set FINLF_CTL to FINLF:getmodule("ModuleSEPControlSurface").
set FINRF_CTL to FINRF:getmodule("ModuleSEPControlSurface").
set FINLR_CTL to FINLR:getmodule("ModuleSEPControlSurface").
set FINRR_CTL to FINRR:getmodule("ModuleSEPControlSurface").

FINLF_CTL:SETFIELD("DEPLOY",1).
FINRF_CTL:SETFIELD("DEPLOY",1).
FINRR_CTL:SETFIELD("DEPLOY",1).
FINLR_CTL:SETFIELD("DEPLOY",1).
	
UNTIL ALTITUDE < 10000{
	LOCK STEERING TO HEADING(180,000,000).
}	

//FLIP TIME
LOCK THROTTLE TO 1.0.
RAP1:ACTIVATE.
RAP2:ACTIVATE.
RAP3:ACTIVATE.	

//Define PID and Targets
LOCK RETRO TO (0.25*(SRFRETROGRADE:VECTOR:NORMALIZED)+0.75*UP:VECTOR:NORMALIZED).
LOCK STEERING TO RETRO.
PRINT "STEERING FOR RETRO..."

LOCK VS to VERTICALSPEED.

SET Kp TO 0.01.
SET Ki TO 0.006.
SET Kd TO 0.006.
SET PID TO PIDLOOP(Kp, Ki, Kd).

LOCK TGTVS to (0.25+ALTITUDE/10).

SET PID:SETPOINT TO TGTVS.

SET thrott TO 1.
LOCK THROTTLE TO thrott.

SET COMPLETE TO 0.

UNTIL COMPLETE  {
    SET thrott TO thrott + PID:UPDATE(TIME:SECONDS, VS).
    // pid:update() is given the input time and input and returns the output. gforce is the input.
    WAIT 0.001.
	SET PID:SETPOINT TO TGTVS.
	IF LANDED{
		SET COMPLETE TO 1.
		}
	IF SPLASHED{
		SET COMPLETE TO 1.
		}
}	